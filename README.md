# TCP Broadcast Chat (Web client + WS<->TCP proxy)

Небольшой Node.js proxy, который соединяет браузерный WebSocket с существующим TCP C++ сервером, использующим framing: `uint32 length (network byte order) + payload`.

## Архитектура
- **WS <-> TCP bridge**: на каждое WS-подключение создается TCP-сокет к `TCP_HOST:TCP_PORT`.
- **Framing и протокол**:
  - из браузера: payload превращается в `4-byte length + payload` и отправляется в TCP;
  - из TCP: поток буферизуется, извлекаются полные фреймы и пересылаются в WS.
  - первый кадр от клиента — никнейм (как ожидает C++ сервер).
- **Личные сообщения**: клиент отправляет JSON (`{type, from, to, body}`); все сообщения все равно идут через TCP broadcast, а фильтрация делается в браузере.
- **Подсказки получателей**: список никнеймов собирается из join/leave и сообщений, доступен в поле `To`.
- **Шифрование личных**: если `To` не `all` и указан `Secret`, тело шифруется AES‑GCM на клиенте (PBKDF2 + salt/iv), расшифровка возможна только с тем же `Secret`.
- **Безопасность**: фреймы > 1MB приводят к закрытию соединения.
- **Backpressure**:
  - если WS не успевает принимать, TCP сокет временно `pause()` до снижения `bufferedAmount`.
  - если TCP не успевает принимать, WS->TCP сообщения временно буферизуются; при переполнении закрываем соединение.
- **Reconnect** (клиент): экспоненциальная задержка 0.5s → 1s → 2s → 5s → 10s.

## Запуск
1. Установить зависимости:

```bash
npm install
```

2. Запустить C++ TCP сервер отдельно.

3. Запустить proxy + статику:

```bash
TCP_HOST=127.0.0.1 TCP_PORT=9000 npm start
```

4. Открыть в браузере:

```
http://localhost:3000
```

5. Открыть 2 вкладки, ввести разные никнеймы, проверить broadcast.

Для личных сообщений укажите `Кому` (никнейм получателя). Чтобы отправить всем — оставьте поле пустым или укажите `всем`.
Для шифрования личных сообщений заполните `Секрет` одинаковым значением у отправителя и получателя.
Опция показа заглушки включает отображение текста для зашифрованных сообщений, иначе показываются маски.
Личные сообщения на сервер уходят как `@name message` (это ожидаемый формат C++ сервера).
Подключение выполняется кнопкой `Подключиться`, а никнейм блокируется до отключения.
Список `Кому` синхронизируется через служебные сообщения `::who::`/`::iam::` при подключении.

## Авторизация
- Вход/регистрация реализованы на backend (Express) с хранением пользователей в `data/users.json`.
- Пароль должен быть минимум 8 символов и содержать строчные, заглавные буквы и цифры.
- Сессия хранится в `localStorage` и проверяется через `/api/me`.

## Порты
- HTTP (статика): `3000`
- WebSocket proxy: `8080`

При необходимости можно переопределить `HTTP_PORT` и `WS_PORT`.
